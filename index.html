<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema inteligente de gestão de banca com metodologias profissionais">
    <title>Gestão Inteligente de Banca</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .header h1 { color: #1e3a8a; font-size: 32px; margin-bottom: 5px; }
        .header p { color: #666; font-size: 14px; }
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .strategy-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        .save-status {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            background: #10b981;
            color: white;
        }
        .save-status.error {
            background: #ef4444;
        }
        .config-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; 
            border-color: #7c3aed; 
        }
        .strategy-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .strategy-option {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        .strategy-option:hover { 
            border-color: #7c3aed; 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124,58,237,0.2);
        }
        .strategy-option.active { 
            border-color: #7c3aed; 
            background: #f5f3ff;
        }
        .strategy-option .name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
            color: #1e3a8a;
        }
        .strategy-option .description {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        .strategy-option .tag {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        .ai-panel {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(124,58,237,0.4);
        }
        .ai-panel h2 {
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ai-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .ai-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .ai-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        .ai-card .value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .ai-card .detail {
            font-size: 12px;
            opacity: 0.8;
        }
        .ai-alert {
            background: rgba(239,68,68,0.2);
            border: 2px solid rgba(239,68,68,0.5);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
        }
        .ai-alert.warning {
            background: rgba(245,158,11,0.2);
            border-color: rgba(245,158,11,0.5);
        }
        .ai-alert.success {
            background: rgba(16,185,129,0.2);
            border-color: rgba(16,185,129,0.5);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card .label { font-size: 12px; color: #666; margin-bottom: 8px; text-transform: uppercase; }
        .stat-card .value { font-size: 24px; font-weight: 700; color: #1e3a8a; }
        .stat-card.positive .value { color: #10b981; }
        .stat-card.negative .value { color: #ef4444; }
        .stat-card .change {
            font-size: 12px;
            margin-top: 5px;
            font-weight: 600;
        }
        .stat-card .change.up { color: #10b981; }
        .stat-card .change.down { color: #ef4444; }
        .tabs {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px 20px 0 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .tab-buttons { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: #f3f4f6;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab-btn:hover { background: #e5e7eb; }
        .tab-btn.active { background: #7c3aed; color: white; }
        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white; 
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124,58,237,0.4);
        }
        .btn-success { background: #10b981; color: white; padding: 8px 16px; font-size: 13px; }
        .btn-danger { background: #ef4444; color: white; padding: 8px 16px; font-size: 13px; }
        .btn-secondary { background: #6b7280; color: white; padding: 8px 16px; font-size: 13px; }
        .btn-info { background: #3b82f6; color: white; padding: 8px 16px; font-size: 13px; }
        .entries-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .entries-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 13px;
        }
        .entries-table td { padding: 15px 12px; border-bottom: 1px solid #e5e7eb; }
        .entries-table tr:hover { background: #f9fafb; }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-win { background: #d1fae5; color: #065f46; }
        .status-loss { background: #fee2e2; color: #991b1b; }
        .actions { display: flex; gap: 8px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; opacity: 0.3; }
        .analysis-panel {
            background: #f9fafb;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #7c3aed;
        }
        .analysis-panel h3 {
            color: #1e3a8a;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .analysis-item {
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #10b981;
        }
        .analysis-item.warning { border-left-color: #f59e0b; }
        .analysis-item.danger { border-left-color: #ef4444; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h2 {
            color: #1e3a8a;
            margin-bottom: 20px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        @media (max-width: 768px) {
            .strategy-selector, .ai-suggestions, .stats-grid { 
                grid-template-columns: 1fr; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Gestão Inteligente de Banca</h1>
            <p>Sistema com IA e metodologias profissionais comprovadas</p>
            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; align-items: center;">
                <span class="strategy-badge" id="currentStrategyBadge">Kelly Criterion Ativo</span>
                <span class="save-status" id="saveStatus">✅ Dados Salvos</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" onclick="manualSave()">💾 Salvar Agora</button>
                <button class="btn btn-info" onclick="exportData()">📥 Exportar Backup</button>
                <button class="btn btn-secondary" onclick="openImportModal()">📤 Importar Backup</button>
                <button class="btn btn-danger" onclick="resetAll()">🗑️ Limpar Tudo</button>
            </div>
        </div>

        <div class="config-panel">
            <h2 style="color: #1e3a8a; margin-bottom: 20px;">⚙️ Configuração</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>💵 Banca Atual (R$)</label>
                    <input type="number" id="bankrollInput" value="20" step="0.01" min="1">
                </div>
                <div class="form-group">
                    <label>📊 Taxa de Acerto Estimada (%)</label>
                    <input type="number" id="winRateInput" value="55" step="1" min="30" max="80">
                    <small style="color: #666; font-size: 12px;">Use seu histórico ou estime conservadoramente (50-55%)</small>
                </div>
            </div>

            <div class="form-group">
                <label>🎯 Estratégia de Gestão</label>
                <div class="strategy-selector">
                    <div class="strategy-option active" onclick="selectStrategy('kelly')">
                        <div class="name">🎲 Kelly Criterion</div>
                        <div class="description">Matemática comprovada. Maximiza crescimento no longo prazo.</div>
                        <span class="tag">PROFISSIONAL</span>
                    </div>
                    <div class="strategy-option" onclick="selectStrategy('kelly_fractional')">
                        <div class="name">🛡️ Kelly Fracionário (1/4)</div>
                        <div class="description">25% do Kelly completo. Mais conservador.</div>
                        <span class="tag">RECOMENDADO</span>
                    </div>
                    <div class="strategy-option" onclick="selectStrategy('fibonacci')">
                        <div class="name">📈 Fibonacci Recovery</div>
                        <div class="description">Progressão após perdas. Recupera gradualmente.</div>
                        <span class="tag">RECUPERAÇÃO</span>
                    </div>
                    <div class="strategy-option" onclick="selectStrategy('percentage')">
                        <div class="name">📊 Percentage Staking</div>
                        <div class="description">% fixo da banca. Simples e eficaz.</div>
                        <span class="tag">CONSERVADOR</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="updateConfig()" style="margin-top: 20px; width: 100%;">
                Atualizar Configuração
            </button>
        </div>

        <div class="ai-panel">
            <h2>🤖 Análise Inteligente & Sugestões</h2>
            <div class="ai-suggestions" id="aiSuggestions"></div>
            <div id="aiAlerts"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">💰 Banca Atual</div>
                <div class="value" id="currentBankroll">R$ 0,00</div>
                <div class="change" id="bankrollChange"></div>
            </div>
            <div class="stat-card" id="profitCard">
                <div class="label">📊 Lucro/Prejuízo</div>
                <div class="value" id="profitValue">R$ 0,00</div>
                <div class="change" id="roiPercent"></div>
            </div>
            <div class="stat-card">
                <div class="label">📈 Win Rate</div>
                <div class="value" id="actualWinRate">0%</div>
                <div class="change" id="winRateChange"></div>
            </div>
            <div class="stat-card">
                <div class="label">🎯 Sequência Atual</div>
                <div class="value" id="currentStreak">-</div>
            </div>
            <div class="stat-card positive">
                <div class="label">✅ Vitórias</div>
                <div class="value" id="totalWins">0</div>
            </div>
            <div class="stat-card negative">
                <div class="label">❌ Derrotas</div>
                <div class="value" id="totalLosses">0</div>
            </div>
            <div class="stat-card">
                <div class="label">📅 Total Apostas</div>
                <div class="value" id="totalBets">0</div>
            </div>
            <div class="stat-card">
                <div class="label">💎 Melhor Odd</div>
                <div class="value" id="bestOdd">-</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-buttons" id="tabButtons"></div>
        </div>
        
        <div class="tab-content">
            <div id="tabContent"></div>
            <div class="analysis-panel" id="analysisPanel"></div>
        </div>
    </div>

    <!-- Modal de Importação -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2>📤 Importar Backup</h2>
            <div class="form-group">
                <label>Cole o JSON do backup aqui:</label>
                <textarea id="importData" rows="10" placeholder='{"config": {...}, "bettingData": {...}}'></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="importData()">Importar</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE PERSISTÊNCIA ROBUSTO
        // ============================================
        
        let config = {
            bankroll: 20,
            initialBankroll: 20,
            strategy: 'kelly',
            estimatedWinRate: 55,
            fibonacciSequence: [1, 1],
            fibonacciIndex: 0,
            lastResult: null,
            lastSave: null
        };

        const strategies = {
            kelly: {
                name: 'Kelly Criterion',
                description: 'Fórmula: (Win% × Odd - 1) / (Odd - 1)',
                calculate: (bankroll, odd, winRate) => {
                    const p = winRate / 100;
                    const q = 1 - p;
                    const b = odd - 1;
                    const kelly = (p * b - q) / b;
                    return Math.max(0, Math.min(0.25, kelly)) * bankroll;
                }
            },
            kelly_fractional: {
                name: 'Kelly Fracionário (1/4)',
                description: '25% do Kelly completo',
                calculate: (bankroll, odd, winRate) => {
                    const fullKelly = strategies.kelly.calculate(bankroll, odd, winRate);
                    return fullKelly * 0.25;
                }
            },
            fibonacci: {
                name: 'Fibonacci Recovery',
                description: 'Progressão após perdas',
                calculate: (bankroll, odd, winRate, fibIndex) => {
                    const sequence = [1,1,2,3,5,8,13,21];
                    const baseUnit = bankroll * 0.02;
                    return baseUnit * (sequence[fibIndex] || 1);
                }
            },
            percentage: {
                name: 'Percentage Staking',
                description: '3-5% fixo',
                calculate: (bankroll, odd, winRate) => {
                    const percent = winRate >= 60 ? 0.05 : winRate >= 55 ? 0.04 : 0.03;
                    return bankroll * percent;
                }
            }
        };

        let bettingData = {};
        let currentTab = null;
        let autoSaveInterval = null;

        // Verificar suporte a localStorage
        function testLocalStorage() {
            try {
                const test = '__test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch(e) {
                return false;
            }
        }

        const hasLocalStorage = testLocalStorage();

        // Salvar dados com tratamento de erro
        function saveData() {
            try {
                config.lastSave = new Date().toISOString();
                
                if (hasLocalStorage) {
                    localStorage.setItem('bettingConfig', JSON.stringify(config));
                    localStorage.setItem('bettingData', JSON.stringify(bettingData));
                    updateSaveStatus(true, 'LocalStorage');
                } else {
                    // Fallback: salvar em cookie
                    document.cookie = `bettingConfig=${encodeURIComponent(JSON.stringify(config))}; max-age=31536000; path=/`;
                    document.cookie = `bettingData=${encodeURIComponent(JSON.stringify(bettingData))}; max-age=31536000; path=/`;
                    updateSaveStatus(true, 'Cookies');
                }
                
                return true;
            } catch (e) {
                console.error('Erro ao salvar:', e);
                updateSaveStatus(false);
                
                // Tentar exportação automática como backup de emergência
                autoExportBackup();
                return false;
            }
        }

        // Carregar dados com fallback
        function loadData() {
            try {
                let loadedConfig = null;
                let loadedData = null;

                if (hasLocalStorage) {
                    const savedConfig = localStorage.getItem('bettingConfig');
                    const savedData = localStorage.getItem('bettingData');
                    
                    if (savedConfig) loadedConfig = JSON.parse(savedConfig);
                    if (savedData) loadedData = JSON.parse(savedData);
                } else {
                    // Fallback: ler de cookies
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        const [name, value] = cookie.trim().split('=');
                        if (name === 'bettingConfig') {
                            loadedConfig = JSON.parse(decodeURIComponent(value));
                        }
                        if (name === 'bettingData') {
                            loadedData = JSON.parse(decodeURIComponent(value));
                        }
                    }
                }

                if (loadedConfig) {
                    config = loadedConfig;
                    document.getElementById('bankrollInput').value = config.bankroll;
                    document.getElementById('winRateInput').value = config.estimatedWinRate;
                    selectStrategy(config.strategy, false);
                }
                
                if (loadedData) {
                    bettingData = loadedData;
                }

                updateSaveStatus(true, hasLocalStorage ? 'LocalStorage' : 'Cookies');
                updateUI();
                
                return true;
            } catch (e) {
                console.error('Erro ao carregar:', e);
                updateSaveStatus(false);
                return false;
            }
        }

        // Status de salvamento
        function updateSaveStatus(success, method = '') {
            const status = document.getElementById('saveStatus');
            if (success) {
                status.className = 'save-status';
                status.textContent = `✅ Salvo (${method})`;
                if (config.lastSave) {
                    const time = new Date(config.lastSave).toLocaleTimeString('pt-BR');
                    status.textContent = `✅ Salvo ${time}`;
                }
            } else {
                status.className = 'save-status error';
                status.textContent = '❌ Erro ao Salvar';
            }
        }

        // Salvamento manual
        function manualSave() {
            if (saveData()) {
                alert('✅ Dados salvos com sucesso!\n\nRecomendação: Faça backup regularmente usando "Exportar Backup".');
            } else {
                alert('❌ Erro ao salvar!\n\nSolução: Exporte um backup manual agora para não perder seus dados.');
                exportData();
            }
        }

        // Exportar dados em JSON
        function exportData() {
            const data = {
                config: config,
                bettingData: bettingData,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gestao-banca-backup-${getToday()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✅ Backup exportado com sucesso!\n\nGuarde este arquivo em local seguro.');
        }

        // Backup automático de emergência
        function autoExportBackup() {
            try {
                const data = {
                    config: config,
                    bettingData: bettingData,
                    exportDate: new Date().toISOString(),
                    note: 'Backup automático de emergência'
                };
                
                // Salvar como download automático
                const dataStr = JSON.stringify(data);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `EMERGENCIA-backup-${Date.now()}.json`;
                a.click();
            } catch(e) {
                console.error('Erro no backup de emergência:', e);
            }
        }

        // Abrir modal de importação
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        // Importar dados
        function importData() {
            try {
                const jsonStr = document.getElementById('importData').value;
                const data = JSON.parse(jsonStr);
                
                if (!data.config || !data.bettingData) {
                    alert('❌ Formato de backup inválido!');
                    return;
                }
                
                if (confirm('⚠️ Isso vai SUBSTITUIR todos os dados atuais. Confirma?')) {
                    config = data.config;
                    bettingData = data.bettingData;
                    
                    saveData();
                    updateUI();
                    closeImportModal();
                    
                    alert('✅ Dados importados com sucesso!');
                }
            } catch (e) {
                alert('❌ Erro ao importar! Verifique se o JSON está correto.');
                console.error(e);
            }
        }

        // Auto-save a cada 30 segundos
        function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            
            autoSaveInterval = setInterval(() => {
                saveData();
            }, 30000); // 30 segundos
        }

        // Resetar tudo
        function resetAll() {
            if (!confirm('⚠️ ATENÇÃO: Isso vai apagar TODOS os dados!\n\nDeseja fazer um backup antes?')) {
                return;
            }
            
            // Oferecer backup
            if (confirm('Fazer backup antes de limpar?')) {
                exportData();
                setTimeout(() => {
                    if (confirm('Backup feito. Confirma limpeza?')) {
                        performReset();
                    }
                }, 1000);
            } else {
                if (confirm('Tem CERTEZA que quer limpar sem backup?')) {
                    performReset();
                }
            }
        }

        function performReset() {
            if (hasLocalStorage) {
                localStorage.clear();
            }
            document.cookie.split(";").forEach((c) => {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
            
            config = {
                bankroll: 20,
                initialBankroll: 20,
                strategy: 'kelly',
                estimatedWinRate: 55,
                fibonacciIndex: 0
            };
            bettingData = {};
            
            updateUI();
            alert('✅ Dados limpos!');
        }

        // ============================================
        // ANÁLISE E LÓGICA (mantida do código anterior)
        // ============================================
        
        function analyzePerformance() {
            let allEntries = [];
            Object.values(bettingData).forEach(day => {
                allEntries = allEntries.concat(day.entries.filter(e => e.result !== 'pending'));
            });

            if (allEntries.length === 0) return null;

            const wins = allEntries.filter(e => e.result === 'win').length;
            const losses = allEntries.filter(e => e.result === 'loss').length;
            const actualWinRate = (wins / allEntries.length) * 100;

            let currentStreak = 0;
            let streakType = null;
            for (let i = allEntries.length - 1; i >= 0; i--) {
                const result = allEntries[i].result;
                if (result === 'pending') continue;
                if (!streakType) {
                    streakType = result;
                    currentStreak = 1;
                } else if (result === streakType) {
                    currentStreak++;
                } else {
                    break;
                }
            }

            const avgWinOdd = allEntries
                .filter(e => e.result === 'win')
                .reduce((sum, e) => sum + e.odd, 0) / (wins || 1);
            
            const avgLossOdd = allEntries
                .filter(e => e.result === 'loss')
                .reduce((sum, e) => sum + e.odd, 0) / (losses || 1);

            const last10 = allEntries.slice(-10);
            const last10Wins = last10.filter(e => e.result === 'win').length;
            const last10WinRate = (last10Wins / last10.length) * 100;

            const totalStaked = allEntries.reduce((sum, e) => sum + e.stake, 0);
            const totalReturned = allEntries
                .filter(e => e.result === 'win')
                .reduce((sum, e) => sum + e.potentialReturn, 0);
            const roi = ((totalReturned - totalStaked) / totalStaked) * 100;

            const bestWinOdd = Math.max(...allEntries.filter(e => e.result === 'win').map(e => e.odd), 0);

            return {
                totalBets: allEntries.length,
                wins,
                losses,
                actualWinRate,
                currentStreak,
                streakType,
                avgWinOdd,
                avgLossOdd,
                last10WinRate,
                roi,
                bestWinOdd,
                totalStaked,
                totalReturned
            };
        }

        function generateAISuggestions() {
            const analysis = analyzePerformance();
            const strategy = strategies[config.strategy];
            
            const p = config.estimatedWinRate / 100;
            const minOdd = 1 / p;
            const idealOdd = minOdd * 1.15;
            const maxOdd = minOdd * 1.35;

            let suggestions = {
                stake: null,
                minOdd: minOdd.toFixed(2),
                idealOdd: idealOdd.toFixed(2),
                maxOdd: maxOdd.toFixed(2),
                maxBetsToday: 3,
                confidence: 'medium'
            };

            const testOdd = parseFloat(idealOdd);
            suggestions.stake = strategy.calculate(
                config.bankroll, 
                testOdd, 
                config.estimatedWinRate,
                config.fibonacciIndex
            );

            if (analysis) {
                if (analysis.actualWinRate < config.estimatedWinRate - 5) {
                    suggestions.stake *= 0.7;
                    suggestions.confidence = 'low';
                    suggestions.maxBetsToday = 2;
                }

                if (analysis.streakType === 'loss' && analysis.currentStreak >= 2) {
                    if (config.strategy === 'fibonacci') {
                        config.fibonacciIndex = Math.min(config.fibonacciIndex + 1, 7);
                    } else {
                        suggestions.stake *= 0.6;
                        suggestions.maxBetsToday = 1;
                    }
                }

                if (analysis.streakType === 'win' && analysis.currentStreak >= 3) {
                    suggestions.stake *= 1.1;
                    suggestions.confidence = 'high';
                    config.fibonacciIndex = 0;
                }

                if (analysis.last10WinRate < 40 && analysis.totalBets >= 10) {
                    suggestions.maxBetsToday = 0;
                    suggestions.confidence = 'danger';
                }
            }

            suggestions.stake = Math.min(suggestions.stake, config.bankroll * 0.10);

            return suggestions;
        }

        function renderAISuggestions() {
            const suggestions = generateAISuggestions();
            const analysis = analyzePerformance();
            const container = document.getElementById('aiSuggestions');
            
            container.innerHTML = `
                <div class="ai-card">
                    <h3>💵 Stake Recomendado</h3>
                    <div class="value">R$ ${suggestions.stake.toFixed(2)}</div>
                    <div class="detail">${((suggestions.stake / config.bankroll) * 100).toFixed(1)}% da banca</div>
                </div>
                <div class="ai-card">
                    <h3>🎯 Faixa de Odds Ideal</h3>
                    <div class="value">${suggestions.idealOdd}</div>
                    <div class="detail">Min: ${suggestions.minOdd} | Máx: ${suggestions.maxOdd}</div>
                </div>
                <div class="ai-card">
                    <h3>📊 Apostas Hoje</h3>
                    <div class="value">${suggestions.maxBetsToday}</div>
                    <div class="detail">Baseado em performance</div>
                </div>
                <div class="ai-card">
                    <h3>🎲 Confiança</h3>
                    <div class="value">${suggestions.confidence === 'high' ? '🟢 Alto' : 
                                        suggestions.confidence === 'medium' ? '🟡 Médio' : 
                                        suggestions.confidence === 'low' ? '🟠 Baixo' : '🔴 Perigo'}</div>
                    <div class="detail">${analysis ? `WR: ${analysis.actualWinRate.toFixed(1)}%` : 'Sem histórico'}</div>
                </div>
            `;

            renderAlerts(suggestions, analysis);
        }

        function renderAlerts(suggestions, analysis) {
            const container = document.getElementById('aiAlerts');
            let alerts = [];

            if (!analysis || analysis.totalBets < 20) {
                alerts.push({
                    type: 'warning',
                    message: '⚠️ Dados insuficientes. Comece conservador até ter 20+ apostas.'
                });
            }

            if (analysis) {
                if (analysis.actualWinRate < config.estimatedWinRate - 10) {
                    alerts.push({
                        type: 'danger',
                        message: `🚨 Win rate real (${analysis.actualWinRate.toFixed(1)}%) muito abaixo da estimativa (${config.estimatedWinRate}%)!`
                    });
                }

                if (analysis.streakType === 'loss' && analysis.currentStreak >= 3) {
                    alerts.push({
                        type: 'danger',
                        message: `⚠️ ${analysis.currentStreak} derrotas seguidas. ${config.strategy === 'fibonacci' ? 'Fibonacci ativo.' : 'Reduza stakes!'}`
                    });
                }

                if (analysis.last10WinRate < 40 && analysis.totalBets >= 10) {
                    alerts.push({
                        type: 'danger',
                        message: `🛑 PARE! Últimas 10: ${analysis.last10WinRate.toFixed(0)}% de acerto.`
                    });
                }

                if (config.bankroll < config.initialBankroll * 0.5) {
                    alerts.push({
                        type: 'danger',
                        message: `💔 Banca caiu 50%. Considere parar e reavaliar.`
                    });
                }
            }

            container.innerHTML = alerts.map(alert => `
                <div class="ai-alert ${alert.type}">
                    ${alert.message}
                </div>
            `).join('');
        }

        function renderAnalysis() {
            const analysis = analyzePerformance();
            const container = document.getElementById('analysisPanel');

            if (!analysis || analysis.totalBets < 5) {
                container.innerHTML = `
                    <h3>📊 Análise Estatística</h3>
                    <p style="color: #666;">Faça pelo menos 5 apostas para análises detalhadas.</p>
                `;
                return;
            }

            const edgePercent = ((analysis.avgWinOdd * (analysis.actualWinRate / 100)) - 1) * 100;

            container.innerHTML = `
                <h3>📊 Análise Estatística Detalhada</h3>
                
                <div class="analysis-item ${analysis.actualWinRate >= 55 ? '' : 'warning'}">
                    <strong>Taxa Real:</strong> ${analysis.actualWinRate.toFixed(1)}% | Estimada: ${config.estimatedWinRate}%
                </div>

                <div class="analysis-item ${analysis.roi > 0 ? '' : 'danger'}">
                    <strong>ROI:</strong> ${analysis.roi.toFixed(2)}% | Apostado: R$ ${analysis.totalStaked.toFixed(2)}
                </div>

                <div class="analysis-item ${edgePercent > 0 ? '' : 'danger'}">
                    <strong>Edge:</strong> ${edgePercent.toFixed(2)}% ${edgePercent > 0 ? '✅' : '❌'}
                </div>
            `;
        }

        function selectStrategy(strategy, shouldUpdate = true) {
            config.strategy = strategy;
            document.querySelectorAll('.strategy-option').forEach(opt => opt.classList.remove('active'));
            if (event) event.target.closest('.strategy-option').classList.add('active');
            document.getElementById('currentStrategyBadge').textContent = strategies[strategy].name + ' Ativo';
            if (shouldUpdate) {
                renderAISuggestions();
                saveData();
            }
        }

        function updateConfig() {
            const newBankroll = parseFloat(document.getElementById('bankrollInput').value);
            const newWinRate = parseInt(document.getElementById('winRateInput').value);
            
            if (newBankroll <= 0) { alert('Banca deve ser > 0!'); return; }
            if (newWinRate < 30 || newWinRate > 80) { alert('Win rate: 30-80%'); return; }
            
            config.bankroll = newBankroll;
            config.estimatedWinRate = newWinRate;
            
            if (!config.initialBankroll) config.initialBankroll = newBankroll;
            
            saveData();
            updateUI();
            alert('✅ Configuração atualizada!');
        }

        function updateStats() {
            const analysis = analyzePerformance();
            
            document.getElementById('currentBankroll').textContent = `R$ ${config.bankroll.toFixed(2)}`;
            
            const profit = config.bankroll - config.initialBankroll;
            const profitPercent = ((profit / config.initialBankroll) * 100).toFixed(1);
            document.getElementById('profitValue').textContent = `R$ ${Math.abs(profit).toFixed(2)}`;
            document.getElementById('roiPercent').innerHTML = `${profit >= 0 ? '📈' : '📉'} ${profitPercent}%`;
            
            const profitCard = document.getElementById('profitCard');
            profitCard.className = 'stat-card';
            if (profit > 0) profitCard.classList.add('positive');
            if (profit < 0) profitCard.classList.add('negative');

            if (analysis) {
                document.getElementById('actualWinRate').textContent = `${analysis.actualWinRate.toFixed(1)}%`;
                document.getElementById('totalBets').textContent = analysis.totalBets;
                document.getElementById('totalWins').textContent = analysis.wins;
                document.getElementById('totalLosses').textContent = analysis.losses;
                document.getElementById('bestOdd').textContent = analysis.bestWinOdd > 0 ? analysis.bestWinOdd.toFixed(2) : '-';
                
                const streakIcon = analysis.streakType === 'win' ? '🔥' : '❄️';
                document.getElementById('currentStreak').textContent = analysis.currentStreak > 0 ? 
                    `${streakIcon} ${analysis.currentStreak}` : '-';

                const wrDiff = analysis.actualWinRate - config.estimatedWinRate;
                document.getElementById('winRateChange').innerHTML = wrDiff >= 0 ? 
                    `<span class="up">▲ ${Math.abs(wrDiff).toFixed(1)}%</span>` :
                    `<span class="down">▼ ${Math.abs(wrDiff).toFixed(1)}%</span>`;
            }
        }

        function renderTabs() {
            const dates = Object.keys(bettingData).sort().reverse();
            const today = getToday();
            if (!dates.includes(today)) {
                dates.unshift(today);
                bettingData[today] = { entries: [] };
            }
            const tabButtons = document.getElementById('tabButtons');
            tabButtons.innerHTML = dates.map((date, index) => `
                <button class="tab-btn ${index === 0 ? 'active' : ''}" onclick="switchTab('${date}')">
                    ${date === today ? '📅 Hoje' : formatDate(date)}
                </button>
            `).join('');
            if (dates.length > 0) renderTabContent(dates[0]);
        }

        function switchTab(date) {
            currentTab = date;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTabContent(date);
        }

        function renderTabContent(date) {
            currentTab = date;
            if (!bettingData[date]) bettingData[date] = { entries: [] };
            
            const day = bettingData[date];
            const suggestions = generateAISuggestions();
            const betsToday = day.entries.length;
            const canBet = betsToday < suggestions.maxBetsToday;

            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div style="background: ${canBet ? '#f0fdf4' : '#fef2f2'}; padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 4px solid ${canBet ? '#10b981' : '#ef4444'};">
                    <h3 style="margin-bottom: 15px; color: #1e3a8a;">
                        ${canBet ? '➕ Nova Aposta' : '🚫 Limite'} - ${formatDate(date)}
                    </h3>
                    ${canBet ? `
                        <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                            Apostas: ${betsToday}/${suggestions.maxBetsToday} | 
                            Stake: R$ ${suggestions.stake.toFixed(2)} | 
                            Odds: ${suggestions.minOdd} - ${suggestions.maxOdd}
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Descrição</label>
                                <input type="text" id="entryDesc" placeholder="Flamengo vs Palmeiras">
                            </div>
                            <div class="form-group">
                                <label>Odd (Ideal: ${suggestions.idealOdd})</label>
                                <input type="number" id="entryOdd" step="0.01" placeholder="${suggestions.idealOdd}">
                            </div>
                            <div class="form-group">
                                <label>Valor (Sugerido: ${suggestions.stake.toFixed(2)})</label>
                                <input type="number" id="entryStake" step="0.01" value="${suggestions.stake.toFixed(2)}">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addEntry()">Adicionar</button>
                    ` : `
                        <p style="color: #dc2626; font-weight: 600;">
                            ⚠️ Limite atingido (${suggestions.maxBetsToday}). ${suggestions.maxBetsToday === 0 ? 'Sistema recomenda PARAR!' : 'Aguarde amanhã.'}
                        </p>
                    `}
                </div>
                
                ${day.entries.length === 0 ? `
                    <div class="empty-state">
                        <div class="icon">📝</div>
                        <p>Nenhuma aposta neste dia.</p>
                    </div>
                ` : `
                    <table class="entries-table">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th>Odd</th>
                                <th>Valor</th>
                                <th>Retorno</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${day.entries.map((entry, index) => `
                                <tr>
                                    <td><strong>${entry.description}</strong></td>
                                    <td>${entry.odd.toFixed(2)}</td>
                                    <td>R$ ${entry.stake.toFixed(2)}</td>
                                    <td>R$ ${entry.potentialReturn.toFixed(2)}</td>
                                    <td>
                                        <span class="status-badge status-${entry.result}">
                                            ${entry.result === 'pending' ? '⏳' : 
                                              entry.result === 'win' ? '✅' : '❌'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="actions">
                                            ${entry.result === 'pending' ? `
                                                <button class="btn btn-success" onclick="markResult(${index}, 'win')">✅</button>
                                                <button class="btn btn-danger" onclick="markResult(${index}, 'loss')">❌</button>
                                            ` : ''}
                                            <button class="btn btn-secondary" onclick="deleteEntry(${index})">🗑️</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `}
            `;
        }

        function addEntry() {
            const desc = document.getElementById('entryDesc').value;
            const odd = parseFloat(document.getElementById('entryOdd').value);
            const stake = parseFloat(document.getElementById('entryStake').value);
            const suggestions = generateAISuggestions();
            
            if (!desc || !odd || !stake) { alert('Preencha todos!'); return; }
            if (stake > config.bankroll) { alert('Banca insuficiente!'); return; }
            
            if (odd < parseFloat(suggestions.minOdd)) {
                if (!confirm(`⚠️ Odd ${odd} abaixo do mínimo (${suggestions.minOdd}). Sem valor matemático! Continuar?`)) return;
            }
            
            const entry = {
                description: desc,
                odd: odd,
                stake: stake,
                potentialReturn: stake * odd,
                result: 'pending',
                timestamp: new Date().toISOString(),
                strategy: config.strategy
            };
            
            bettingData[currentTab].entries.push(entry);
            config.lastResult = null;
            saveData();
            renderTabContent(currentTab);
            renderAISuggestions();
            alert('✅ Aposta adicionada!');
        }

        function markResult(index, result) {
            const entry = bettingData[currentTab].entries[index];
            if (entry.result !== 'pending') { alert('Já finalizada!'); return; }
            
            entry.result = result;
            config.lastResult = result;
            
            if (result === 'win') {
                config.bankroll += entry.potentialReturn;
                if (config.strategy === 'fibonacci') {
                    config.fibonacciIndex = Math.max(0, config.fibonacciIndex - 1);
                }
            } else {
                if (config.strategy === 'fibonacci') {
                    config.fibonacciIndex = Math.min(config.fibonacciIndex + 1, 7);
                }
            }
            
            saveData();
            updateUI();
            
            const message = result === 'win' ? 
                `🎉 +R$ ${(entry.potentialReturn - entry.stake).toFixed(2)}` :
                `❌ -R$ ${entry.stake.toFixed(2)}`;
            alert(message);
        }

        function deleteEntry(index) {
            if (!confirm('Deletar?')) return;
            const entry = bettingData[currentTab].entries[index];
            if (entry.result === 'pending') {
                config.bankroll += entry.stake;
            } else if (entry.result === 'win') {
                config.bankroll -= entry.potentialReturn;
            }
            bettingData[currentTab].entries.splice(index, 1);
            saveData();
            updateUI();
        }

        function updateUI() {
            document.getElementById('bankrollInput').value = config.bankroll.toFixed(2);
            renderAISuggestions();
            updateStats();
            renderTabs();
            renderAnalysis();
        }

        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // Inicialização
        window.onload = function() {
            loadData();
            startAutoSave();
            
            // Salvar antes de sair
            window.addEventListener('beforeunload', () => {
                saveData();
            });
        };
    </script>
</body>
</html>